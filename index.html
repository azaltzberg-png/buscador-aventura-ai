<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adonait Business LLC | Market Status Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #0f172a; --accent: #c5a059; 
            --status-active: #10b981; --status-pending: #f59e0b; --status-closed: #ef4444; --status-off: #64748b;
        }
        body { font-family: 'Montserrat', sans-serif; margin: 0; display: flex; height: 100vh; background: #f1f5f9; overflow: hidden; }
        
        #ui-panel { width: 420px; background: white; z-index: 100; box-shadow: 10px 0 30px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .header { background: var(--primary); color: white; padding: 15px; text-align: center; border-bottom: 4px solid var(--accent); }
        
        .filter-area { padding: 12px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; width: 100%; box-sizing: border-box; }
        .full-width { grid-column: span 2; }
        
        button { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 700; grid-column: span 2; }

        #results { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .card { background: white; border-radius: 12px; border: 1px solid #eee; margin-bottom: 15px; cursor: pointer; overflow: hidden; position: relative; }
        .card img { width: 100%; height: 160px; object-fit: cover; }
        
        /* ETIQUETAS DE ESTADO */
        .status-badge { position: absolute; top: 10px; left: 10px; padding: 5px 10px; border-radius: 6px; color: white; font-size: 10px; font-weight: 700; text-transform: uppercase; z-index: 5; }
        .bg-active { background: var(--status-active); }
        .bg-pending { background: var(--status-pending); }
        .bg-closed { background: var(--status-closed); }
        .bg-off { background: var(--status-off); }

        .card-info { padding: 12px; }
        .sync-tag { font-size: 9px; color: var(--status-active); font-weight: 700; margin-bottom: 5px; }

        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 95%; max-width: 800px; max-height: 90vh; border-radius: 15px; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: white; background: var(--primary); width: 35px; height: 35px; border-radius: 50%; display: flex; justify-content: center; align-items: center; }

        #map { flex-grow: 1; }
        .ws-float { position: fixed; bottom: 20px; right: 20px; background: #25d366; color: white; padding: 14px 24px; border-radius: 50px; text-decoration: none; font-weight: 700; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div id="modal">
    <div class="close-modal" onclick="closeModal()">&times;</div>
    <div class="modal-content" id="modal-data"></div>
</div>

<a href="https://wa.me/19545887564" class="ws-float" target="_blank">üì≤ Contactar a Alberto</a>

<div id="ui-panel">
    <div class="header">
        <h1 style="margin:0; font-size:1rem;">ADONAIT BUSINESS LLC</h1>
        <small style="color:var(--accent)">Sincronizaci√≥n Global Miami RE</small>
    </div>
    <div class="filter-area">
        <select id="f-trans" class="full-width">
            <option value="Active">Solo Disponibles (Active)</option>
            <option value="Pending">Bajo Contrato (Pending)</option>
            <option value="Closed">Vendidas/Rentadas (Closed)</option>
            <option value="All">Todo el Historial</option>
        </select>
        <input type="text" id="f-zip" placeholder="ZIP Code">
        <select id="f-radius">
            <option value="0">Solo este ZIP</option>
            <option value="5">Radio 5 Millas</option>
            <option value="10">Radio 10 Millas</option>
        </select>
        <input type="number" id="f-price" placeholder="Precio M√°x $" class="full-width">
        <button onclick="applyFilters()">CONSULTAR ESTADOS</button>
    </div>
    <div id="results"></div>
</div>

<div id="map"></div>

<script>
    const BROWSER_TOKEN = 'ef52c732beb2036c9168768f7b5246cc';
    let map, markers = [], currentData = [], lastSync;

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 25.9565, lng: -80.1392 },
            zoom: 12
        });
        applyFilters(); 
    }

    async function applyFilters() {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = "<p style='text-align:center;'>Actualizando estados...</p>";
        
        const zip = document.getElementById('f-zip').value;
        const radius = document.getElementById('f-radius').value;
        const statusFilter = document.getElementById('f-trans').value;
        const price = document.getElementById('f-price').value;

        let filters = [];
        if(statusFilter !== "All") filters.push(`MlsStatus eq '${statusFilter}'`);
        if(price) filters.push(`ListPrice le ${price}`);

        let url = `https://api.bridgedataoutput.com/api/v2/OData/miamire/Property?access_token=${BROWSER_TOKEN}`;
        
        if(zip && radius > 0) {
            url += `&$filter=${encodeURIComponent(filters.join(" and "))}&near=${zip},${radius}`;
        } else {
            if(zip) filters.push(`PostalCode eq '${zip}'`);
            url += `&$filter=${encodeURIComponent(filters.join(" and "))}`;
        }

        url += `&$top=25&$orderby=ModificationTimestamp desc`;

        try {
            const resp = await fetch(url);
            const data = await resp.json();
            lastSync = new Date();
            currentData = data.value || [];
            render(currentData);
        } catch (e) { resultsDiv.innerHTML = "Error de sincronizaci√≥n."; }
    }

    function getStatusClass(status) {
        if(status === 'Active') return 'bg-active';
        if(status === 'Pending' || status === 'Active Under Contract') return 'bg-pending';
        if(status === 'Closed' || status === 'Sold') return 'bg-closed';
        return 'bg-off';
    }

    function translateStatus(status) {
        const dict = { 'Active': 'Disponible', 'Pending': 'Pendiente', 'Closed': 'Vendido/Rentado', 'Active Under Contract': 'Bajo Contrato' };
        return dict[status] || status;
    }

    function render(props) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = "";
        markers.forEach(m => m.setMap(null));

        props.forEach((p, index) => {
            if(!p.Latitude) return;
            const pos = { lat: parseFloat(p.Latitude), lng: parseFloat(p.Longitude) };
            const marker = new google.maps.Marker({ position: pos, map: map });
            markers.push(marker);

            const statusClass = getStatusClass(p.MlsStatus);
            const statusText = translateStatus(p.MlsStatus);
            const img = p.Media?.[0]?.MediaURL || 'https://via.placeholder.com/400x200';
            
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="status-badge ${statusClass}">${statusText}</div>
                <img src="${img}">
                <div class="card-info">
                    <div class="sync-tag">Sincronizado ahora</div>
                    <div style="font-size:1.2rem; font-weight:700;">$${p.ListPrice.toLocaleString()}</div>
                    <div style="font-size:11px; color:#64748b;">${p.UnparsedAddress}</div>
                </div>`;
            card.onclick = () => { map.panTo(pos); showDetail(index); };
            resultsDiv.appendChild(card);
        });
    }

    function showDetail(index) {
        const p = currentData[index];
        const modal = document.getElementById('modal');
        const content = document.getElementById('modal-data');
        const img = p.Media?.[0]?.MediaURL || 'https://via.placeholder.com/800x400';

        content.innerHTML = `
            <div class="status-badge ${getStatusClass(p.MlsStatus)}" style="top:20px; left:20px; font-size:14px; padding:8px 15px;">${translateStatus(p.MlsStatus)}</div>
            <img src="${img}" style="width:100%; height:380px; object-fit:cover;">
            <div style="padding:25px;">
                <h2 style="margin:0; color:var(--primary);">$${p.ListPrice.toLocaleString()}</h2>
                <p><b>${p.UnparsedAddress}</b> | ML# ${p.ListingId}</p>
                <div style="background:#f8fafc; padding:15px; border-radius:10px; display:flex; gap:20px; margin:15px 0;">
                    <div>üõèÔ∏è ${p.BedroomsTotal} Hab</div>
                    <div>üöø ${p.BathroomsFullTotal} Ba√±os</div>
                    <div>üìê ${p.LivingArea} SqFt</div>
                </div>
                <p style="font-size:14px; color:#444;">${p.PublicRemarks || 'No hay descripci√≥n disponible.'}</p>
                <div style="background:var(--primary); color:white; padding:20px; border-radius:12px; margin-top:20px; position:relative;">
                    <h3 style="margin:0;">Agente: Alberto Zaltzberg</h3>
                    <p>Adonait Business LLC | 954-588-7564</p>
                    <a href="https://wa.me/19545887564?text=Alberto, info del ML# ${p.ListingId} (${p.MlsStatus})" 
                       style="background:#25d366; color:white; padding:12px 20px; border-radius:8px; text-decoration:none; display:inline-block; font-weight:bold; margin-top:10px;">
                       CONTACTAR AHORA
                    </a>
                </div>
                <div style="font-size:10px; color:gray; margin-top:20px;">
                    Copyright Miami Association of Realtors Regional MLS. Information is deemed reliable but not guaranteed.
                </div>
            </div>
        `;
        modal.style.display = 'flex';
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCFDOG6McuD5d6JUUGi2g5ATLNa7LX1LrQ&callback=initMap" async defer></script>
</body>
</html>
